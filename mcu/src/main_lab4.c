// Broderick Bownds
// brbownds@hmc.edu
// 9/29/2025

// lab4_starter.c
// Fur Elise, E155 Lab 4
// Updated Fall 2024

#include "RCC.h"
#include "GPIO.h"
#include "TIM.h"

// Pitch in Hz, duration in ms
const int notes[][2] = {
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	250},
{  0,	125},
{494,	125},
{523,	125},
{587,	125},
{659,	375},
{392,	125},
{699,	125},
{659,	125},
{587,	375},
{349,	125},
{659,	125},
{587,	125},
{523,	375},
{330,	125},
{587,	125},
{523,	125},
{494,	250},
{  0,	125},
{330,	125},
{659,	125},
{  0,	250},
{659,	125},
{1319,	125},
{  0,	250},
{623,	125},
{659,	125},
{  0,	250},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{416,	125},
{494,	125},
{523,	250},
{  0,	125},
{330,	125},
{659,	125},
{623,	125},
{659,	125},
{623,	125},
{659,	125},
{494,	125},
{587,	125},
{523,	125},
{440,	250},
{  0,	125},
{262,	125},
{330,	125},
{440,	125},
{494,	250},
{  0,	125},
{330,	125},
{523,	125},
{494,	125},
{440,	500},
{  0,	0}};

int main(void) {
    // configure system clock (PLL to 80 MHz)
    configureFlash();
    configureClock();

    // Enable GPIOA + TIM15 + TIM16
    RCC->AHB2ENR |= (1 << 0);     // GPIOAEN
    RCC->APB2ENR |= (1 << 16);    // TIM15EN
    RCC->APB2ENR |= (1 << 17);    // TIM16EN

    // Configure PA6 = TIM16_CH1 (AF14)
    pinMode(6, GPIO_ALT);
    GPIOA->AFRL &= ~(0xF << (6 * 4));
    GPIOA->AFRL |=  (14 << (6 * 4));

    // Start PWM on TIM16
    const uint32_t TIMER_CLK_HZ = 80000000/80;
    setupPWM(TIM16, TIMER_CLK_HZ, 440, 50); // A4 default

    int song_length = sizeof(notes) / sizeof(notes[0]);
    for (int i = 0; i < song_length; i++) {
        int freq = notes[i][0];
        int dur  = notes[i][1];

        if (dur == 0) break;
        
        if (freq == 0) {
            // Rest: stop channel output
            TIM16->CCER &= ~(1 << 0);
            delay_ms(dur);
            TIM16->CCER |= (1 << 0);
        } else {
            changePWM(TIM16, TIMER_CLK_HZ, freq, 50);
            delay_ms(dur);
        }
    }

    TIM16->CR1 &= ~1; // stop PWM
    while (1);
}